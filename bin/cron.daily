#! /bin/sh
set -e

CDIMAGE_ROOT=/srv/cdimage.no-name-yet.com
DIST=warty

ARCHES="${ARCHES:-amd64 i386 powerpc}"
PATH="$CDIMAGE_ROOT/bin:${PATH:+:$PATH}"
DATE="$(date +%Y%m%d)${DATE_SUFFIX:+.$DATE_SUFFIX}"
PUBLISH="$CDIMAGE_ROOT/www/daily/$DATE"

CDOUT="$CDIMAGE_ROOT/scratch/debian-cd"

if [ -z "$DEBUG" ]; then
	exec >"$CDIMAGE_ROOT/log/daily-$DATE.log" 2>&1
fi

echo "===== Syncing Ubuntu mirror ====="
date
anonftpsync

echo "===== Updating archive of local packages ====="
date
update-local-indices

echo "===== Updating debian-installer task list ====="
date
(cd "$CDIMAGE_ROOT/debian-cd"
 . CONF.sh
 cd tasks
 ../tools/generate_di_list)

echo "===== Building Ubuntu daily CDs ====="
date
cd "$CDIMAGE_ROOT/debian-cd"
for arch in $ARCHES; do
	./build.sh "$arch" || true
done

if [ -z "$DEBUG" ]; then
	echo "===== Publishing ====="
	date
	for arch in $ARCHES; do
		if [ -e "$CDOUT/$arch/$DIST-$arch-1.raw" ]; then
			mkdir -p "$PUBLISH"
			mv "$CDOUT/$arch/$DIST-$arch-1.raw" \
			   "$PUBLISH/$DIST-$arch-1.iso"
			mv "$CDOUT/$arch/$DIST-$arch-1.list" \
			   "$PUBLISH/$DIST-$arch-1.list"
		else
			echo "No CD for $arch!" >&2
		fi
	done
	if [ -d "$PUBLISH" ]; then
		cd "$PUBLISH"
		md5sum "$DIST"-* > MD5SUMS
		cd ..
		ln -nsf "$DATE" current
	else
		echo "No CDs produced!" >&2
	fi

	echo "===== Archiving debian-cd code ====="
	date
	cd "$CDIMAGE_ROOT"
	tar cjvf www/code/debian-cd.tar.bz2 debian-cd

	echo "===== Triggering mirrors ====="
	date
	sync-auckland
fi

echo "===== Finished ====="
date
