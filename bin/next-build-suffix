#! /bin/sh
set -e

CDIMAGE_ROOT=/srv/cdimage.no-name-yet.com
STAMP="$CDIMAGE_ROOT/etc/.next-build-suffix"

if [ -z "$1" ]; then
	echo 'Usage: next-build-suffix DATE' >&2
	exit 1
fi

DATE="$1"

# TODO: race condition, need locking in cron.daily

SUFFIX=
if [ "$DATE_SUFFIX" ]; then
	SUFFIX="$DATE_SUFFIX"
elif grep -qs "^$DATE:" "$STAMP"; then
	SUFFIX="$(grep -s "^$DATE:" "$STAMP" | cut -d: -f2)"
fi

if [ "$SUFFIX" ]; then
	echo "$DATE:$(($SUFFIX + 1))" > "$STAMP"
	echo ".$SUFFIX"
else
	echo "$DATE:1" > "$STAMP"
fi
