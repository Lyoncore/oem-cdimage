#! /bin/sh
set -e

CDIMAGE_ROOT=/srv/cdimage.no-name-yet.com
. "$CDIMAGE_ROOT/etc/config"

GERMINATE_OUT="$CDIMAGE_ROOT/scratch/germinate"

mkemptydir () {
	rm -rf "$1"
	mkdir -p "$1"
}

case $DIST in
	warty)
		GERMINATE_DISTS="$DIST,$DIST-security"
		;;
	*)
		GERMINATE_DISTS="$DIST"
		;;
esac

for arch in $ARCHES; do
	echo "Germinating for $DIST/$arch ..."
	mkemptydir "$GERMINATE_OUT/$DIST-$arch"
	cd "$GERMINATE_OUT/$DIST-$arch"
	if [ "$GERMINATE_HINTS" ] && [ -f "$GERMINATE_HINTS" ]; then
		cp -a "$GERMINATE_HINTS" hints
	fi
	"$CDIMAGE_ROOT/germinate/germinate.py" --mirror "file://$CDIMAGE_ROOT/ftp/" --seed-dist "$DIST" --dist "$GERMINATE_DISTS" --components main,restricted --arch "$arch" --no-rdepends
done
