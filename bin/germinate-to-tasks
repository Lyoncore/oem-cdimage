#! /bin/sh

# Outputs debian-cd task lists to $CDIMAGE_ROOT/scratch/tasks/.

CDIMAGE_ROOT=/srv/cdimage.no-name-yet.com
. "$CDIMAGE_ROOT/etc/config"

GERMINATE_OUT="$CDIMAGE_ROOT/scratch/germinate"
TASKS_OUT="$CDIMAGE_ROOT/scratch/tasks"
MIRROR="$CDIMAGE_ROOT/ftp"

mkemptydir () {
	rm -rf "$1"
	mkdir -p "$1"
}

mkemptydir "$TASKS_OUT/$DIST"

for seed in base ship installer supported; do
	exec >"$TASKS_OUT/$DIST/$seed"
	if [ "$seed" = supported ]; then
		seedsource="$seed+build-depends"
	else
		seedsource="$seed"
	fi
	for arch in $ARCHES; do
		echo "#ifdef ARCH_$arch"
		< "$GERMINATE_OUT/$DIST-$arch/$seedsource" \
			tail -n +3 | head -n -2 | cut -d' ' -f1
		echo "#endif /* ARCH_$arch */"
	done
done

# Hackily exclude kernel-image-* from the installer task. Those udebs only
# exist to satisfy dependencies when building the debian-installer package.
grep -v ^kernel-image- "$TASKS_OUT/$DIST/installer" \
	> "$TASKS_OUT/$DIST/installer.new"
mv "$TASKS_OUT/$DIST/installer.new" "$TASKS_OUT/$DIST/installer"

# Handle Desktop separately, to make sure we don't accidentally end up out
# of sync with the archive and break the second-stage install.
exec >"$TASKS_OUT/$DIST/desktop"
for arch in $ARCHES; do
	echo "#ifdef ARCH_$arch"
	(zcat "$MIRROR/dists/$DIST/main/binary-$arch/Packages.gz";
	 zcat "$MIRROR/dists/$DIST/restricted/binary-$arch/Packages.gz") |
		grep-dctrl -nsPackage -FTask ubuntu-desktop | sort
	echo "#endif /* ARCH_$arch */"
done
