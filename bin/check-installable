#! /bin/sh
set -e

export CDIMAGE_ROOT="${CDIMAGE_ROOT:-/srv/cdimage.ubuntu.com}"
. "$CDIMAGE_ROOT/etc/config"

BRITNEY="${BRITNEY:-$CDIMAGE_ROOT/britney}"

IMAGETOP="${IMAGETOP:-$CDIMAGE_ROOT/scratch/$PROJECT/$IMAGE_TYPE/tmp}"
LIVE="${LIVE:-$CDIMAGE_ROOT/scratch/$PROJECT/$IMAGE_TYPE/live}"

tmpdir=

cleanup () {
	if [ "$tmpdir" ]; then
		rm -r "$tmpdir"
	fi
}

use_temp_dir () {
	if [ -z "$tmpdir" ]; then
		tmpdir="$(mktemp -d)"
		trap cleanup EXIT HUP INT QUIT TERM
	fi
}

mkemptydir "$BRITNEY/data/$PROJECT/$IMAGE_TYPE/$DIST"
for fullarch in $ARCHES; do
	arch="${fullarch%%+*}"
	if [ "$CDIMAGE_SQUASHFS_BASE" ] && \
	   [ -e "$LIVE/$fullarch.squashfs" ]; then
		use_temp_dir
		unsquashfs -d "$tmpdir/$fullarch" "$LIVE/$fullarch.squashfs" \
			/var/lib/dpkg/status >/dev/null
		grep-dctrl -XFStatus 'install ok installed' \
			"$tmpdir/$fullarch/var/lib/dpkg/status" \
			>> "$BRITNEY/data/$PROJECT/$IMAGE_TYPE/$DIST/Packages_$arch"
	fi

	for component in main restricted universe multiverse; do
		packages="$IMAGETOP/$DIST-$fullarch/CD1/dists/$DIST/$component/binary-$arch/Packages.gz"
		if [ -e "$packages" ]; then
			zcat "$packages" >> "$BRITNEY/data/$PROJECT/$IMAGE_TYPE/$DIST/Packages_$arch"
		fi
	done
	if [ ! -e "$BRITNEY/data/$PROJECT/$IMAGE_TYPE/$DIST/Packages_$arch" ]; then
		echo "No Packages.gz for $DIST/$arch; not checking" >&2
	fi
done
> "$BRITNEY/data/$PROJECT/$IMAGE_TYPE/$DIST/Sources"

mkemptydir "$BRITNEY/report/$PROJECT/$IMAGE_TYPE"
# Sometimes this inexplicably hangs on a futex. We'll give it thirty seconds
# and then kill it.
kill-after 30 "$BRITNEY/rptprobs.sh" "$BRITNEY/data/$PROJECT/$IMAGE_TYPE/$DIST" "$BRITNEY/report/$PROJECT/$IMAGE_TYPE/${DIST}_probs.html" "$CAPPROJECT $DIST" || true
