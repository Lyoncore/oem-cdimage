#! /bin/sh
set -e

CDIMAGE_ROOT=/srv/cdimage.no-name-yet.com
CDOUT="$CDIMAGE_ROOT/scratch/debian-cd"
BRITNEY_REPORT="$CDIMAGE_ROOT/britney/report"
TRACKER=http://torrent.ubuntu.com:6969/announce

DIST="${DIST:-warty}"
ARCHES="${ARCHES:-amd64 i386 powerpc}"

DATE="$1"
PUBLISH="$CDIMAGE_ROOT/www/daily/$DATE"

for arch in $ARCHES; do
	if [ -e "$CDOUT/$arch/$DIST-$arch-1.raw" ]; then
		mkdir -p "$PUBLISH"
		mv "$CDOUT/$arch/$DIST-$arch-1.raw" \
		   "$PUBLISH/$DIST-$arch.iso"
		mv "$CDOUT/$arch/$DIST-$arch-1.list" \
		   "$PUBLISH/$DIST-$arch.list"
	else
		echo "No CD for $arch!" >&2
	fi

	# BitTorrent integration
	echo "Creating $arch torrent ..."
	btmakemetafile "$TRACKER" \
		--comment "Ubuntu CD cdimage.ubuntu.com" \
		"$PUBLISH/$DIST-arch.iso" >/dev/null
done
if [ -d "$PUBLISH" ]; then
	if [ -e "$BRITNEY_REPORT/${DIST}_probs.html" ]; then
		cp -a "$BRITNEY_REPORT/${DIST}_probs.html" "$PUBLISH/report.html"
	fi
	cd "$PUBLISH"
	md5sum "$DIST"-* > MD5SUMS
	cd ..
	ln -nsf "$DATE" current
else
	echo "No CDs produced!" >&2
fi
