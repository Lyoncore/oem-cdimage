#! /bin/sh
set -e

export CDIMAGE_ROOT="${CDIMAGE_ROOT:-/srv/cdimage.ubuntu.com}"
. "$CDIMAGE_ROOT/etc/config"
. "$CDIMAGE_ROOT/bin/functions.sh"

LIVE_OUT="$CDIMAGE_ROOT/scratch/$PROJECT/$IMAGE_TYPE/live"

fetch () {
	case $1 in
		/*)
			ln "$1" "$2"
			;;
		*)
			ret=0
			wget -nv "$1" -O "$2" || ret=$?
			if [ "$ret" -ne 0 ]; then
				rm -f "$2"
			fi
			return $ret
			;;
	esac
}

mkemptydir "$LIVE_OUT"

# TheOpenCD goes on the amd64/i386 live CDs, and on the Edubuntu add-on CDs.
for arch in $CPUARCHES; do
	if winfoss="$(find-live-filesystem "$arch" winfoss)"; then
		fetch "$winfoss" "$LIVE_OUT/$arch.winfoss.tgz"
	fi
done
