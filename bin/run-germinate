#! /bin/sh
set -e

export CDIMAGE_ROOT=/srv/cdimage.no-name-yet.com
. "$CDIMAGE_ROOT/etc/config"
. "$CDIMAGE_ROOT/bin/functions.sh"

GERMINATE_OUT="$CDIMAGE_ROOT/scratch/$PROJECT/germinate"

case $DIST in
	warty)
		GERMINATE_DISTS="${GERMINATE_DISTS:-$DIST,$DIST-security}"
		;;
	*)
		GERMINATE_DISTS="${GERMINATE_DISTS:-$DIST}"
		;;
esac

case $PROJECT in
	ubuntu)
		# for legacy purposes
		GERMINATE_SEED_DIST="$DIST"
		;;
	*)
		GERMINATE_SEED_DIST="$PROJECT-$DIST"
		;;
esac

mkindex () {
	target="$1"
	subdir="${target%/*}"

	mkemptydir "$GERMINATE_OUT/$subdir"
	for file in "$@"; do
		if [ "${file#/}" = "$file" ]; then
			absfile="$(find-mirror "$arch")/$file"
		else
			absfile="$file"
		fi
		if [ -f "$absfile" ]; then
			zcat "$absfile"
		fi
	done | gzip -c > "$GERMINATE_OUT/$target"
}

for arch in $ARCHES; do
	echo "Germinating for $DIST/$arch ..."

	IFS_SAVE="$IFS"
	IFS=,
	for germinate_dist in $GERMINATE_DISTS; do
		IFS="$IFS_SAVE"
		mkindex "dists/$germinate_dist/main/binary-$arch/Packages.gz" \
			"dists/$germinate_dist/restricted/binary-$arch/Packages.gz" \
			${LOCAL:+$LOCALDEBS/dists/$germinate_dist/local/binary-$arch/Packages.gz}
		mkindex "dists/$germinate_dist/main/source/Sources.gz" \
			"dists/$germinate_dist/restricted/source/Sources.gz" \
			${LOCAL:+$LOCALDEBS/dists/$germinate_dist/local/binary-$arch/Sources.gz}
		mkindex "dists/$germinate_dist/main/debian-installer/binary-$arch/Packages.gz" \
			"dists/$germinate_dist/restricted/debian-installer/binary-$arch/Packages.gz" \
			${LOCAL:+$LOCALDEBS/dists/$germinate_dist/local/debian-installer/binary-$arch/Packages.gz}
		IFS=,
	done
	IFS="$IFS_SAVE"

	mkemptydir "$GERMINATE_OUT/$DIST-$arch"
	cd "$GERMINATE_OUT/$DIST-$arch"
	if [ "$GERMINATE_HINTS" ] && [ -f "$GERMINATE_HINTS" ]; then
		cp -a "$GERMINATE_HINTS" hints
	fi
	"$CDIMAGE_ROOT/germinate/germinate.py" ${LOCAL_SEEDS:+--seed-source "$LOCAL_SEEDS"} --mirror "file://$GERMINATE_OUT/" --seed-dist "$GERMINATE_SEED_DIST" --dist "$GERMINATE_DISTS" --arch "$arch" --no-rdepends

	if [ "$DIST" = breezy ]; then
		# Unfortunately, we now need a second germinate run to
		# figure out the dependencies of language packs and the
		# like.
		echo "Re-germinating for $DIST/$arch language pack dependencies ..."
		> ship.acsets
		EXTRAS=
		for pkg in $(< ship.seed tail -n +3 | head -n -2 | cut -d' ' -f1 | egrep '^(language-pack-[^-]+|language-pack-gnome-[^-]+|language-pack-kde-[^-]+|kde-i18n-.+|language-support-[^-]+|oem-config)$'); do
			EXTRAS="${EXTRAS:+$EXTRAS,}desktop/$pkg"
			echo "$pkg" >> ship.acsets
		done
		"$CDIMAGE_ROOT/germinate/germinate.py" ${LOCAL_SEEDS:+--seed-source "$LOCAL_SEEDS"} --mirror "file://$GERMINATE_OUT/" --seed-dist "$GERMINATE_SEED_DIST" --dist "$GERMINATE_DISTS" --arch "$arch" --no-rdepends ${EXTRAS:+--seed-packages "$EXTRAS"}
	fi
done
