#! /bin/sh
set -e

export CDIMAGE_ROOT=/srv/cdimage.no-name-yet.com
. "$CDIMAGE_ROOT/etc/config"
. "$CDIMAGE_ROOT/bin/functions.sh"

GERMINATE_OUT="$CDIMAGE_ROOT/scratch/$PROJECT/germinate"

case $DIST in
	warty)
		GERMINATE_DISTS="$DIST,$DIST-security"
		;;
	*)
		GERMINATE_DISTS="$DIST"
		;;
esac

case $PROJECT in
	ubuntu)
		# for legacy purposes
		GERMINATE_SEED_DIST="$DIST"
		;;
	*)
		GERMINATE_SEED_DIST="$PROJECT-$DIST"
		;;
esac

for arch in $ARCHES; do
	echo "Germinating for $DIST/$arch ..."
	mkemptydir "$GERMINATE_OUT/$DIST-$arch"
	cd "$GERMINATE_OUT/$DIST-$arch"
	if [ "$GERMINATE_HINTS" ] && [ -f "$GERMINATE_HINTS" ]; then
		cp -a "$GERMINATE_HINTS" hints
	fi
	"$CDIMAGE_ROOT/germinate/germinate.py" --mirror "file://$CDIMAGE_ROOT/ftp/" --seed-dist "$GERMINATE_SEED_DIST" --dist "$GERMINATE_DISTS" --components main,restricted --arch "$arch" --no-rdepends
done
