#! /bin/sh
set -e

export CDIMAGE_ROOT=/srv/cdimage.no-name-yet.com
. "$CDIMAGE_ROOT/etc/config"
. "$CDIMAGE_ROOT/bin/functions.sh"

LIVE_OUT="$CDIMAGE_ROOT/scratch/$PROJECT/live"

fetch () {
	case $1 in
		/*)
			ln "$1" "$2"
			;;
		*)
			wget -nv "$1" -O "$2"
			;;
	esac
}

mkemptydir "$LIVE_OUT"
for arch in $ARCHES; do
	if fetch "$(find-live-filesystem "$arch" cloop)" \
			"$LIVE_OUT/$arch.cloop"; then
		:
	elif fetch "$(find-live-filesystem "$arch" squashfs)" \
			"$LIVE_OUT/$arch.squashfs"; then
		:
	else
		rm -f "$LIVE_OUT/$arch".*
		continue
	fi
	case $DIST in
		warty|hoary|breezy)
			;;
		*)
			for item in kernel initrd; do
				for url in $(find-live-filesystem "$arch" "$item"); do
					subarch="${url##*/}"
					subarch="${subarch#*.*.*-}"
					if ! fetch "$url" "$LIVE_OUT/$arch.$item-$subarch"; then
						rm -f "$LIVE_OUT/$arch".*
						continue 2
					fi
				done
			done
			;;
	esac
	fetch "$(find-live-filesystem "$arch" manifest)" \
		"$LIVE_OUT/$arch.manifest" || true
done

# TheOpenCD goes on the amd64/i386 live CDs.
for arch in $ARCHES; do
	if winfoss="$(find-live-filesystem "$arch" winfoss)"; then
		fetch "$winfoss" "$LIVE_OUT/$arch.winfoss.tgz"
	fi
done
