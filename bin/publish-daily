#! /bin/sh
set -e

CDIMAGE_ROOT=/srv/cdimage.no-name-yet.com
. "$CDIMAGE_ROOT/etc/config"

CDOUT="$CDIMAGE_ROOT/scratch/debian-cd"
BRITNEY_REPORT="$CDIMAGE_ROOT/britney/report"
TRACKER=http://torrent.ubuntu.com:6969/announce

if [ -z "$1" ]; then
	echo 'Usage: publish-daily DATE' >&2
	exit 1
fi

DATE="$1"
PUBLISH="$CDIMAGE_ROOT/www/full/daily/$DATE"

for arch in $ARCHES; do
	if [ -e "$CDOUT/$arch/$DIST-install-$arch.raw" ]; then
		echo "Publishing $arch ..."
		mkdir -p "$PUBLISH"
		mv "$CDOUT/$arch/$DIST-install-$arch.raw" \
		   "$PUBLISH/$DIST-install-$arch.iso"
		mv "$CDOUT/$arch/$DIST-install-$arch.list" \
		   "$PUBLISH/$DIST-install-$arch.list"

		# Jigdo integration
		if [ -e "$CDOUT/$arch/$DIST-install-$arch.jigdo" ]; then
			echo "Publishing $arch jigdo ..."
			mv "$CDOUT/$arch/$DIST-install-$arch.jigdo" \
			   "$PUBLISH/$DIST-install-$arch.jigdo"
			mv "$CDOUT/$arch/$DIST-install-$arch.template" \
			   "$PUBLISH/$DIST-install-$arch.template"
		else
			echo "No jigdo for $arch!" >&2
		fi

		# BitTorrent integration
		echo "Creating $arch torrent ..."
		btmakemetafile "$TRACKER" \
			--comment "Ubuntu CD cdimage.ubuntu.com" \
			"$PUBLISH/$DIST-install-$arch.iso" >/dev/null
	else
		echo "No CD for $arch!" >&2
	fi
done
if [ -d "$PUBLISH" ]; then
	if [ -e "$BRITNEY_REPORT/${DIST}_probs.html" ]; then
		cp -a "$BRITNEY_REPORT/${DIST}_probs.html" "$PUBLISH/report.html"
	fi
	cd "$PUBLISH"
	md5sum "$DIST"-*.iso > MD5SUMS
	cd ..
	ln -nsf "$DATE" current
else
	echo "No CDs produced!" >&2
fi
