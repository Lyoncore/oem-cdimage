#! /bin/sh
set -e

CDIMAGE_ROOT=/srv/cdimage.no-name-yet.com
. "$CDIMAGE_ROOT/etc/config"

GERMINATE_OUT="$CDIMAGE_ROOT/scratch/germinate"

mkemptydir () {
	rm -rf "$1"
	mkdir -p "$1"
}

mkindex () {
	target="$1"
	subdir="${target%/*}"

	mkemptydir "$GERMINATE_OUT/$subdir"
	for file in "$@"; do
		zcat "$CDIMAGE_ROOT/ftp/$file"
	done | gzip -c > "$GERMINATE_OUT/$target"
}

for arch in $ARCHES; do
	echo "Germinating for $DIST/$arch ..."
	mkindex "dists/$DIST/main/binary-$arch/Packages.gz" "dists/$DIST/restricted/binary-$arch/Packages.gz"
	mkindex "dists/$DIST/main/source/Sources.gz" "dists/$DIST/restricted/source/Sources.gz"
	mkindex "dists/$DIST/main/debian-installer/binary-$arch/Packages.gz" "dists/$DIST/restricted/debian-installer/binary-$arch/Packages.gz"
	mkemptydir "$GERMINATE_OUT/$DIST-$arch"
	cd "$GERMINATE_OUT/$DIST-$arch"
	if [ "$GERMINATE_HINTS" ] && [ -f "$GERMINATE_HINTS" ]; then
		cp -a "$GERMINATE_HINTS" hints
	fi
	"$CDIMAGE_ROOT/germinate/germinate.py" --mirror "file://$GERMINATE_OUT/" --seed-dist "$DIST" --dist "$DIST" --arch "$arch" --no-rdepends
done
