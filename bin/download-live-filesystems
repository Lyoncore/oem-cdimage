#! /bin/sh
set -e

export CDIMAGE_ROOT="${CDIMAGE_ROOT:-/srv/cdimage.ubuntu.com}"
. "$CDIMAGE_ROOT/etc/config"
. "$CDIMAGE_ROOT/bin/functions.sh"

LIVE_OUT="$CDIMAGE_ROOT/scratch/$PROJECT/$IMAGE_TYPE/live"

fetch () {
	case $1 in
		'')
			return 1
			;;
		/*)
			ln "$1" "$2"
			;;
		*)
			ret=0
			wget -nv "$1" -O "$2" || ret=$?
			if [ "$ret" -ne 0 ]; then
				rm -f "$2"
			fi
			return $ret
			;;
	esac
}

mkemptydir "$LIVE_OUT"

if [ "$CDIMAGE_LIVE" ]; then
	for arch in $ARCHES; do
		if fetch "$(find-live-filesystem "$arch" cloop)" \
				"$LIVE_OUT/$arch.cloop"; then
			:
		elif fetch "$(find-live-filesystem "$arch" squashfs)" \
				"$LIVE_OUT/$arch.squashfs"; then
			:
		else
			continue
		fi
		case $DIST in
			warty|hoary|breezy)
				;;
			*)
				for item in kernel initrd; do
					for url in $(find-live-filesystem "$arch" "$item"); do
						flavour="${url##*/}"
						flavour="${flavour#*.*.*-}"
						fetch "$url" "$LIVE_OUT/$arch.$item-$flavour" || true
					done
				done
				;;
		esac
		fetch "$(find-live-filesystem "$arch" manifest)" \
			"$LIVE_OUT/$arch.manifest" || true
		fetch "$(find-live-filesystem "$arch" manifest-desktop)" \
			"$LIVE_OUT/$arch.manifest-desktop" || true

		if [ "$PROJECT" != livecd-base ] && [ "$CDIMAGE_DVD" != 1 ]; then
			(export http_proxy=http://squid.internal:3128/;
			fetch "$(find-live-filesystem "$arch" wubi)" \
				"$LIVE_OUT/$arch.wubi.exe" || true)
			if [ "$PROJECT" != edubuntu ]; then
				(export http_proxy=http://squid.internal:3128/;
				fetch "$(find-live-filesystem "$arch" umenu)" \
					"$LIVE_OUT/$arch.umenu.exe" || true)
				if [ -f "$LIVE_OUT/$arch.umenu.exe" ]; then
					cat > "$LIVE_OUT/$arch.autorun.inf" << EOF
[autorun]
open=umenu.exe
icon=umenu.exe
EOF
				fi
			fi
		fi
	done
fi

# TODO evand 2008-02-15: TheOpenCD goes on the Edubuntu add-on CDs until I can
# confirm that Oliver wants umenu.
if ([ "$PROJECT" = edubuntu ] && [ "$CDIMAGE_INSTALL" ]); then
	for arch in $CPUARCHES; do
		if winfoss="$(find-live-filesystem "$arch" winfoss)"; then
			fetch "$winfoss" "$LIVE_OUT/$arch.winfoss.tgz"
		fi
	done
fi
