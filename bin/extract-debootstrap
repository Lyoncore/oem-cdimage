#! /bin/sh
set -e

export CDIMAGE_ROOT="${CDIMAGE_ROOT:-/srv/cdimage.ubuntu.com}"
. "$CDIMAGE_ROOT/etc/config"
. "$CDIMAGE_ROOT/bin/functions.sh"

DEBOOTSTRAP_OUT="$CDIMAGE_ROOT/scratch/$PROJECT/$IMAGE_TYPE/debootstrap"

mkemptydir "$DEBOOTSTRAP_OUT"
for fullarch in $ARCHES; do
	arch="${fullarch%%+*}"
	mirror="$(find-mirror "$arch")"
	udeb="$(zcat "$mirror/dists/$DIST/main/debian-installer/binary-$arch/Packages.gz" | grep-dctrl -nsFilename -PX debootstrap-udeb)"
	case "$DIST" in
		warty|hoary|breezy|dapper|edgy|feisty|gutsy)
			debootstrap_script="./usr/lib/debootstrap/scripts/$DIST"
			;;
		*)
			debootstrap_script="./usr/share/debootstrap/scripts/$DIST"
			;;
	esac
	if [ -f "$mirror/$udeb" ]; then
		dpkg --fsys-tarfile "$mirror/$udeb" | \
			tar -xOf - "$debootstrap_script" \
			> "$DEBOOTSTRAP_OUT/$DIST-$fullarch"
	else
		echo "No debootstrap-udeb for $DIST/$arch!" >&2
	fi
done
