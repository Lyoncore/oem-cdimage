#! /bin/sh

# Outputs debian-cd task lists to $CDIMAGE_ROOT/scratch/$PROJECT/tasks/.

CDIMAGE_ROOT=/srv/cdimage.no-name-yet.com
. "$CDIMAGE_ROOT/etc/config"
. "$CDIMAGE_ROOT/bin/functions.sh"

GERMINATE_OUT="$CDIMAGE_ROOT/scratch/$PROJECT/germinate"
TASKS_OUT="$CDIMAGE_ROOT/scratch/$PROJECT/tasks"
MIRROR="$CDIMAGE_ROOT/ftp"

mkemptydir "$TASKS_OUT/$DIST"

for seed in base desktop ship installer casper supported; do
	exec >"$TASKS_OUT/$DIST/$seed"
	if [ "$seed" = supported ]; then
		seedsource="$seed+build-depends"
	else
		seedsource="$seed"
	fi
	for arch in $ARCHES; do
		echo "#ifdef ARCH_$arch"
		< "$GERMINATE_OUT/$DIST-$arch/$seedsource" \
			tail -n +3 | head -n -2 | cut -d' ' -f1
		echo "#endif /* ARCH_$arch */"
	done
done

# Hackily exclude kernel-image-* from the installer and casper tasks. Those
# udebs only exist to satisfy dependencies when building the
# debian-installer package.
for seed in installer casper; do
	grep -v ^kernel-image- "$TASKS_OUT/$DIST/$seed" \
		> "$TASKS_OUT/$DIST/$seed.new"
	mv "$TASKS_OUT/$DIST/$seed.new" "$TASKS_OUT/$DIST/$seed"
done

# Help debian-cd to regenerate Task headers, to make sure that we don't
# accidentally end up out of sync with the archive and break the
# second-stage install.
for arch in $ARCHES; do
	exec >"$TASKS_OUT/$DIST/override.$arch"
	for seed in base desktop ship; do
		< "$GERMINATE_OUT/$DIST-$arch/$seed" \
			tail -n +3 | head -n -2 | cut -d' ' -f1 | \
			sed "s/\$/  Task  $PROJECT-$seed/"
	done
done
