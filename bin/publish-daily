#! /bin/sh
set -e

CDIMAGE_ROOT=/srv/cdimage.no-name-yet.com
. "$CDIMAGE_ROOT/etc/config"

CDOUT="$CDIMAGE_ROOT/scratch/debian-cd"
BRITNEY_REPORT="$CDIMAGE_ROOT/britney/report"

if [ -z "$1" ]; then
	echo 'Usage: publish-daily DATE [IMAGE_TYPE]' >&2
	exit 1
fi

DATE="$1"
IMAGE_TYPE="${2:-daily}"
PUBLISH="$CDIMAGE_ROOT/www/full/$IMAGE_TYPE/$DATE"

for arch in $ARCHES; do
	if [ -e "$CDOUT/$arch/$DIST-install-$arch.raw" ]; then
		echo "Publishing $arch ..."
		mkdir -p "$PUBLISH"
		mv "$CDOUT/$arch/$DIST-install-$arch.raw" \
		   "$PUBLISH/$DIST-install-$arch.iso"
		mv "$CDOUT/$arch/$DIST-install-$arch.list" \
		   "$PUBLISH/$DIST-install-$arch.list"

		# Jigdo integration
		if [ -e "$CDOUT/$arch/$DIST-install-$arch.jigdo" ]; then
			echo "Publishing $arch jigdo ..."
			mv "$CDOUT/$arch/$DIST-install-$arch.jigdo" \
			   "$PUBLISH/$DIST-install-$arch.jigdo"
			mv "$CDOUT/$arch/$DIST-install-$arch.template" \
			   "$PUBLISH/$DIST-install-$arch.template"
		else
			echo "No jigdo for $arch!" >&2
		fi
	else
		echo "No CD for $arch!" >&2
	fi
done

i=1
while [ -e "$CDOUT/src/$DIST-src-$i.raw" ]; do
	echo "Publishing source $i ..."
	mkdir -p "$PUBLISH/source"
	mv "$CDOUT/src/$DIST-src-$i.raw" "$PUBLISH/source/$DIST-src-$i.iso"
	mv "$CDOUT/src/$DIST-src-$i.list" "$PUBLISH/source/$DIST-src-$i.list"

	# Jigdo integration
	if [ -e "$CDOUT/src/$DIST-src-$i.jigdo" ]; then
		echo "Publishing source $i jigdo ..."
		mv "$CDOUT/src/$DIST-src-$i.jigdo" \
		   "$PUBLISH/source/$DIST-src-$i.jigdo"
		mv "$CDOUT/src/$DIST-src-$i.template" \
		   "$PUBLISH/source/$DIST-src-$i.template"
	else
		echo "No jigdo for source $i!" >&2
	fi

	i="$(($i + 1))"
done

if [ -d "$PUBLISH" ]; then
	if [ -e "$BRITNEY_REPORT/${DIST}_probs.html" ]; then
		cp -a "$BRITNEY_REPORT/${DIST}_probs.html" "$PUBLISH/report.html"
	fi
	(cd "$PUBLISH" && md5sum "$DIST"-*.iso > MD5SUMS)
	if [ -d "$PUBLISH/source" ]; then
		(cd "$PUBLISH/source" && md5sum "$DIST"-*.iso > MD5SUMS)
	fi
	ln -nsf "$DATE" "$CDIMAGE_ROOT/www/full/$IMAGE_TYPE/current"
else
	echo "No CDs produced!" >&2
fi
